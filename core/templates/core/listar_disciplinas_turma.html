{% extends 'core/base.html' %}
{% load static %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/lista_disciplinas.css' %}">

{% endblock %}

{% block content %}

<main class="conteudo-principal">

    <!-- Exibir mensagens -->
    {% if messages %}
        <div>
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
        </div>
    {% endif %}

    <!-- CABE√áALHO -->
    <div class="header-docentes">

        <!-- VOLTAR -->
        <a href="{% url 'listar_turmas' %}">
            <button class="btn-voltar">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
        </a>

        <h1 class="titulo-pagina">
            Disciplinas da Turma 
            <span class="subtitulo-turma">{{ turma.nome }}</span>
        </h1>

        <!-- EDITAR + EXCLUIR TURMA (lado direito) -->
        <div style="display:flex; gap:10px;">
            <a href="{% url 'editar_turma' turma.id %}">
                <button class="btn-adicionar" style="background:#1e90ff">
                    <i class="fas fa-pen"></i> 
                </button>
                
            </a>

            <!-- BOT√ÉO EXCLUIR TURMA COM MODAL -->
            <button class="btn-adicionar" style="background:#d9534f" onclick="abrirModal({{ turma.id }})">
                <i class="fas fa-trash"></i>
            </button>

        </div>

    </div>

    <!-- CARD -->
    <div class="card-tabela">

        <!-- BUSCA + BOT√ïES -->
        <div class="barra-busca-linha">

            <!-- BUSCA -->
            <div class="barra-busca">
                <form method="get" style="width:100%; display:flex;">
                    <input type="text"
                           name="q"
                           placeholder="Buscar disciplina..."
                           value="{{ query }}">
                </form>
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>

            <!-- A√á√ïES AO LADO DA BUSCA -->
            <div style="display:flex; gap:10px;">
                <a href="{% url 'cadastrar_disciplina_turma' turma.id %}">
                    <button class="btn-adicionar">
                        Adicionar Disciplina
                    </button>
                </a>

                <a href="{% url 'grade_horaria' turma.id %}">
                    <button class="btn-grade">
                        üìÖ Grade Hor√°ria
                    </button>
                </a>
            </div>

        </div>

        <!-- TABELA -->
        <div class="container-tabela">

            <table class="tabela-docentes">
                <thead>
                    <tr>
                        <th class="coluna-nome">Disciplina</th>
                        <th class="coluna-email">Professor</th>
                        <th class="coluna-acoes">A√ß√µes</th>
                    </tr>
                </thead>

                <tbody>
                    {% for disciplina in disciplinas %}
                    <tr>
                        <td>{{ disciplina.nome }}</td>
                        <td>{{ disciplina.professor.nome_completo }}</td>

                        <td class="coluna-acoes">
                            <a href="{% url 'visualizar_disciplinas' disciplina.id %}" title="Visualizar">
                                <i class="fa-solid fa-eye"></i>
                            </a>

                            <a href="{% url 'editar_disciplina' disciplina.id %}" title="Editar">
                                <i class="fa-solid fa-pen"></i>
                            </a>

                            <a href="{% url 'excluir_disciplina' disciplina.id %}"
                               title="Excluir"
                               onclick="return confirm('Deseja realmente excluir esta disciplina?');">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" style="text-align:center; padding:15px;">
                            Nenhuma disciplina cadastrada.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>

        </div>

    </div>

</main>

<!-- MODAL DE EXCLUS√ÉO -->
<div id="modal-excluir" class="modal">
    <div class="modal-conteudo">
        <h2>Confirmar exclus√£o</h2>
        <p>Digite sua senha para continuar:</p>
        <input type="password" id="senha-excluir" placeholder="Senha" required>
        <p>Tem certeza que deseja excluir?</p>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn-adicionar" style="background:#d9534f" id="btn-confirmar">Sim, tenho certeza</button>
            <button class="btn-voltar" onclick="fecharModal()">N√£o</button>
        </div>
    </div>
</div>

<script>
let turmaSelecionada = null;

function abrirModal(turmaId) {
    turmaSelecionada = turmaId;
    document.getElementById('modal-excluir').style.display = 'block';
}

function fecharModal() {
    turmaSelecionada = null;
    document.getElementById('modal-excluir').style.display = 'none';
}

// Evento do bot√£o "Sim, tenho certeza"
document.getElementById('btn-confirmar').addEventListener('click', function() {
    const senha = document.getElementById('senha-excluir').value;

    if(!senha) {
        alert('Digite a senha antes de confirmar.');
        return;
    }

    // cria formul√°rio din√¢mico e envia POST
    const form = document.createElement('form');
    form.method = 'POST';
    // Gera a URL dinamicamente com o nome da rota
        const urlExcluir = "{% url 'excluir_turma' 0 %}".replace('/0/', `/${turmaSelecionada}/`);
        form.action = urlExcluir;
    form.style.display = 'none';

    // CSRF token
    const csrfToken = '{{ csrf_token }}';
    const inputCsrf = document.createElement('input');
    inputCsrf.type = 'hidden';
    inputCsrf.name = 'csrfmiddlewaretoken';
    inputCsrf.value = csrfToken;
    form.appendChild(inputCsrf);

    // Senha
    const inputSenha = document.createElement('input');
    inputSenha.type = 'hidden';
    inputSenha.name = 'senha';
    inputSenha.value = senha;
    form.appendChild(inputSenha);

    document.body.appendChild(form);
    form.submit();
});
</script>

{% endblock %}
